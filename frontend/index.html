<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>eBPF Autoscaler Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-dagre/2.5.0/cytoscape-dagre.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1e1e1e; color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: #007acc; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .badge { background: #252526; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; }
        #cy { flex: 1; background: #1e1e1e; }
        
        /* Floating Stats Panel */
        #details {
            position: absolute; top: 70px; right: 20px; width: 250px;
            background: #252526; border: 1px solid #3e3e42;
            padding: 15px; border-radius: 8px; display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .stat-label { color: #aaa; }
        .stat-val { font-weight: bold; }
        .status-ok { color: #4caf50; }
        .status-warn { color: #ff9800; }
        .status-crit { color: #f44336; }
    </style>
</head>
<body>

<header>
    <h1>ðŸš€ eBPF Topology Autoscaler <span class="badge">Live</span></h1>
    <div style="font-size: 0.9rem; color: #ccc;">Auto-refresh: 2s</div>
</header>

<div id="cy"></div>

<div id="details">
    <h3 id="det-title" style="margin-top:0">Service Details</h3>
    <div class="stat-row"><span class="stat-label">Latency:</span> <span id="det-lat" class="stat-val">0ms</span></div>
    <div class="stat-row"><span class="stat-label">Status:</span> <span id="det-status" class="stat-val">Unknown</span></div>
</div>

<script>
    // --- CONFIGURATION ---
    // Important: We assume you will port-forward the Aggregator to port 8000
    const API_URL = "http://localhost:8000/api/graph";

    // Initialize Graph
    var cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': '#007acc',
                    'label': 'data(id)',
                    'color': '#fff',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'width': 60, 'height': 60,
                    'font-size': '12px'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': '#555',
                    'target-arrow-color': '#555',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier'
                }
            },
            {
                selector: '.slow',
                style: { 'background-color': '#ff9800', 'line-color': '#ff9800' }
            },
            {
                selector: '.critical',
                style: { 'background-color': '#f44336', 'line-color': '#f44336', 'target-arrow-color': '#f44336', 'width': 4 }
            }
        ],
        layout: { name: 'breadthfirst', directed: true, padding: 50 }
    });

    // Helper to diff data to prevent screen flicker
    function updateGraph(data) {
        const metrics = data.metrics || {};
        const topology = data.topology || {};
        
        // 1. Add Nodes
        const existingNodes = new Set();
        cy.nodes().forEach(n => existingNodes.add(n.id()));

        // Collect all services from topology keys + values
        const services = new Set([...Object.keys(metrics), ...Object.keys(topology)]);
        Object.values(topology).forEach(targets => targets.forEach(t => services.add(t)));

        services.forEach(svc => {
            if (svc === "bpf-agent" || svc === "autoscaler" || svc === "aggregator") return; // Hide infra

            // Color Logic
            const lat = metrics[svc] || 0;
            let cls = "";
            if (lat > 50) cls = "critical";
            else if (lat > 20) cls = "slow";

            if (!existingNodes.has(svc)) {
                cy.add({ group: 'nodes', data: { id: svc, latency: lat }, classes: cls });
            } else {
                // Update existing
                const node = cy.$id(svc);
                node.data('latency', lat);
                node.classes(cls); // Update color
            }
        });

        // 2. Add Edges
        const existingEdges = new Set();
        cy.edges().forEach(e => existingEdges.add(e.id()));

        Object.entries(topology).forEach(([source, targets]) => {
            if (source === "autoscaler") return;
            targets.forEach(target => {
                if (target.includes("10.")) return; // Skip IPs
                
                const edgeId = `${source}->${target}`;
                if (!existingEdges.has(edgeId)) {
                    // Check validity to avoid crash
                    if (cy.$id(source).length && cy.$id(target).length) {
                        cy.add({ group: 'edges', data: { id: edgeId, source: source, target: target } });
                    }
                }
            });
        });

        // Layout only on first load or significant change
        if (existingNodes.size === 0 && services.size > 0) {
            cy.layout({ name: 'breadthfirst', directed: true, spacingFactor: 1.5 }).run();
        }
    }

    // Polling Loop
    setInterval(() => {
        fetch(API_URL)
            .then(res => res.json())
            .then(data => updateGraph(data))
            .catch(err => console.log("API Error (Is port-forward active?):", err));
    }, 2000);

    // Click Interaction
    cy.on('tap', 'node', function(evt){
        var node = evt.target;
        var lat = node.data('latency');
        document.getElementById('details').style.display = 'block';
        document.getElementById('det-title').innerText = node.id();
        document.getElementById('det-lat').innerText = lat + " ms";
        
        let status = "Healthy";
        let color = "#4caf50";
        if(lat > 50) { status = "CRITICAL"; color = "#f44336"; }
        else if(lat > 20) { status = "Warning"; color = "#ff9800"; }
        
        const el = document.getElementById('det-status');
        el.innerText = status;
        el.style.color = color;
    });

</script>
</body>
</html>
